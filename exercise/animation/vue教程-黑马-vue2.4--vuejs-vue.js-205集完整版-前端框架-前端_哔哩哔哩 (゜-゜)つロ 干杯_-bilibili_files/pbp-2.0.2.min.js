/*!
 * pbp | v2.0.2
 * 11/25/2019, 4:56:12 PM
 * wushiyang <wushiyang@bilibili.com>, lipengcheng <lipengcheng@bilibili.com>, tangjunxing <tangjunxing@bilibili.com>
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).BiliPBP=t()}(this,function(){"use strict";function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function e(e,t,i){return t&&a(e.prototype,t),i&&a(e,i),e}function u(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function r(l){return new Promise(function e(t,i){if(l.url){var a=new XMLHttpRequest;l.pending&&(l.pending.xhr=a);var r=l.url;if(l.params){var n=Object.keys(l.params).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(l.params[e])}).join("&");if(!(r=function(e,t){var i=e.split("?");if(2===i.length)i[1]?e+="&"+t:e+=t;else{if(1!==i.length)return"";e+="?"+t}return e}(r,n)))return void i(new Error("xhr url parse error"))}for(var o in l.method||(l.method="GET"),a.open(l.method.toUpperCase(),r,!0),l.withCredentials&&(a.withCredentials=!0),l.responseType?a.responseText=l.responseType:a.responseType="text",a.onreadystatechange=function(){4===a.readyState&&(200<=a.status&&a.status<300?t(function(e,t){if("json"===t){var i,a=e.responseText;try{i=JSON.parse(a)}catch(e){i={}}return i}}(a,"json")):l.retry&&"number"==typeof l.retry&&!l.pending.manualPause?(l.retry-=1,function(a){return new Promise(function(e,t){var i=setTimeout(e,2e3);a.stopTimer=function(){clearInterval(i),i=null,a.stopTimer=null,t(new Error("stop timer"))}})}(l.pending).then(function(){l.retryFunction&&"function"==typeof l.retryFunction&&l.retryFunction(),e(t,i)}).catch(i)):i({http_url:r,http_method:l.method,http_status:a.status}))},l.headers)l.headers.hasOwnProperty(o)&&a.setRequestHeader(o,l.headers[o]);"object"===s(l.data)&&(a.setRequestHeader("Content-Type","application/json; charset=UTF-8"),l.data=JSON.stringify(l.data)),a.send(l.data||null)}else i(new Error("xhr url missing"))})}var n=function(e,t,i,a){return r({url:"//".concat(i||"api.bilibili.com","/pbp/data?cid=").concat(t,"&version=").concat(a),method:"get",withCredentials:!0})},h="bilibili_pbp",j="bilibili_pbp_guide",R="bilibili_pbp_panel",q="bilibili_pbp_panel_style",g="bilibili-player-video-control",v=1e3,o="2.0.2",K={l:16,m:24,h:32},G={l:.5,m:.2,h:.1},J={b:{fillColor:"255,255,255",playedColor:"35,173,229"},p:{fillColor:"255,255,255",playedColor:"251,114,153"},r:{fillColor:"255,255,255",playedColor:"212,63,65"},g:{fillColor:"255,255,255",playedColor:"80,161,100"}},t=function(){function a(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),this.options=e,this._clearStore(),this._status="wait",this._pbptag={},this._pbptagstr=""}return e(a,null,[{key:"isSupport",value:function(){return!!(window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver)&&!!Promise}},{key:"loadLab",value:function(e){e&&("undefined"!=typeof window&&window.player&&window.player.loadLab?window.player.loadLab(1):setTimeout(function(){a.loadLab(--e)},500))}}]),e(a,[{key:"init",value:function(e,t){var c=this,i=0<arguments.length&&void 0!==e?e:"default",d=1<arguments.length&&void 0!==t?t:function(){};if("destroy"===this._status&&(this._status="wait"),!a.isSupport())return this._debugLog("init unsupported"),this.destroy(),d(new Error("environment not support"));this.eventKey=this.pbpDebugKey||i||"default",this._debugLog("init key =",this.eventKey),this._injectBiliPlayer().then(function(){return"destroy"===c._status?(c.destroy(),d(new Error("_status destroy"))):(c._debugLog("injectBiliPlayer complete"),c.aid&&c.cid?n(c.aid,c.cid,c.pbpDebugApi,o):d(new Error("aid || cid miss")))}).then(function(e){if("destroy"===c._status)return c.destroy(),d(new Error("_status destroy"));if(document.getElementById(h))return c.destroy(),d(new Error("old pbp not destroy"));if(c.video=document.querySelector("video"),!c.video)return c.destroy(),d(new Error("video element miss"));var t=e.step_sec,i=e.events,a=void 0===i?{}:i,r=e.tag,n=void 0===r?{}:r,o=e.tagstr,l=void 0===o?"":o,s=e.debug;c._pbptag=n,c._pbptagstr=l,c._debugLog("init api response debug: ",s);var p=a[c.eventKey];if(!p||!p.length||!t)return c.destroy(),c._debugLog("events[".concat(c.eventKey,"] length empty"),s),d(new Error("events[key] length empty"));c._debugLog("init async start: api.cidData complete",c.eventKey,p),c.st={name:c.eventKey,key:c.eventKey,points:c._calculatePercentage(p,t)},c._checkVersion(),c._recoverZebraDataFromCache(),c._initPanel(c.eventKey,a),d(null,c.st)}).catch(function(e){d?d(e):console.error(e)})}},{key:"show",value:function(){if("destroy"!==this._status&&"show"!==this._status&&this.st){this._status="show",this._debugLog("call show");var e=localStorage.getItem("pbp_height"),t=K[e]?K[e]:K.m;this.pbpStyle=document.createElement("style"),this.pbpStyle.innerHTML="#bilibili_pbp { display: flex; cursor: pointer; position: absolute; bottom: 3px; left: -12px; width: calc(100% + 24px); height: ".concat(t,"px; opacity: 0; z-index: 0; } #bilibili_pbp.show { bottom: calc(100% - 2px); opacity: 1; left: 0; width: 100%; } .webfullscreen #bilibili_pbp, .mode-fullscreen #bilibili_pbp { bottom: 5px; } .webfullscreen #bilibili_pbp.show, .bilibili-player.mode-fullscreen #bilibili_pbp.show { bottom: calc(100% + 4px + 1px); } .bui-thumb { z-index: 1; } .bilibili-player-video-toast-wrp { z-index: 1000; } .bui-slider .bui-track.bui-track-video-progress { height: 4px!important; border-radius: 0; } .bui-slider .bui-track .bui-bar-wrap { border-radius: 0; } .bilibili-player-video-state { z-index: 998; }  .video-control-show .subtitle-position.subtitle-position-bc { bottom: 74px; } .mode-fullscreen .video-control-show .subtitle-position.subtitle-position-bc { bottom: 84px; } .mode-webfullscreen .video-control-show .subtitle-position.subtitle-position-bc { bottom: 84px; } #bilibili_pbp.pin { opacity: 1; } .video-control-show .bilibili-player-video-interactive { margin-bottom: 16px; } .webfullscreen .bilibili-player-video-interactive, .mode-fullscreen .bilibili-player-video-interactive { margin-bottom: 24px; }"),document.head.appendChild(this.pbpStyle),this._updatePbpConfig(),this._create(),this._refresh(),this._setPin(this,localStorage.getItem("pbp_pin")),this._observerChange()}}},{key:"hide",value:function(){if("destroy"!==this._status&&"hide"!==this._status&&(this._status="hide",this._debugLog("call hide"),this.pbp))try{var e=document.getElementsByClassName(g)[0];e.removeChild(this.pbp);var t=document.getElementById(j);this.video&&(this.video.removeEventListener("seeking",this.videoUpdateCallback),this.video.removeEventListener("timeupdate",this.videoUpdateCallback)),window.player&&(window.player.removeEventListener("video_controlbar",this.videoControlbarCallback),window.player.removeEventListener("video_heartbeat",this.videoHeartbeatCallback)),this.pbpStyle&&document.head.removeChild(this.pbpStyle),this.themeStyle&&(document.head.removeChild(this.themeStyle),this.themeStyle=null),t&&e.removeChild(t)}catch(e){console.log(e)}}},{key:"destroy",value:function(){"destroy"!==this._status&&(this._debugLog("call destroy"),this.hide(),this._clearStore(),this._status="destroy")}},{key:"_clearStore",value:function(){this.st=null,this.aid=null,this.cid=null,this.pbpStyle=null,this.themeStyle=null,this.pbp=null,this.video=null,this.player=null,this.pbpComponent=null,this.zebraStart=0,this.zebraEnd=null,this.zebraAreas=[],this.lastUpdateTime=null,this.cachedZebraDatas=null,this.cachedZebraDataIndex=null,this.firstRefreshFlag=!1,this.videoHeartbeatFirstFlag=!1,this.eventKey=null,this.pbpDebugApi=localStorage.getItem("pbp_debug_api")||"",this.pbpDebugKey=localStorage.getItem("pbp_debug_key")||"",this.debug=!!this.options.debug||"1"===localStorage.getItem("pbp_debug")}},{key:"_checkVersion",value:function(){this._debugLog("pbp.js version: ".concat(o));var e=localStorage.getItem("pbp_version");"2.0.1"===e&&localStorage.setItem("pbp_opacity","m"),e!==o&&localStorage.setItem("pbp_version",o)}},{key:"_setThemeStyle",value:function(e){this.themeStyle&&"show"===this._status&&document.head.removeChild(this.themeStyle),"1"===localStorage.getItem("pbpstate")&&(this.themeStyle=document.createElement("style"),this.themeStyle.innerHTML=".bui-slider .bui-track.bui-track-video-progress .bui-bar-normal.bui-bar.bui-bar-normal { background: rgba(".concat(e,", 1); }"),document.head.appendChild(this.themeStyle))}},{key:"_updatePbpConfig",value:function(){var e=localStorage.getItem("pbp_theme");e=J[e]?J[e]:J.b;var t=localStorage.getItem("pbp_opacity");t=G[t]?G[t]:G.m,this.st.opacity=t,this.st.fillColor="rgb(".concat(e.fillColor,")"),this.st.playedColor="rgb(".concat(e.playedColor,")"),this._setThemeStyle(e.playedColor)}},{key:"_setTheme",value:function(e){this._debugLog("call setTheme");var t=J[e]?J[e]:J.b;this.pbpComponent.fillRect.setAttribute("fill","rgb(".concat(t.fillColor,")")),this.pbpComponent.playedRect.setAttribute("fill","rgb(".concat(t.playedColor,")")),localStorage.setItem("pbp_theme",e),this._setThemeStyle(t.playedColor)}},{key:"_setHeight",value:function(e,t){e._debugLog("call setHeight");var i=K[t];e.pbp&&(e.pbp.style.height="".concat(i,"px")),localStorage.setItem("pbp_height",t)}},{key:"_setOpacity",value:function(e,t){e._debugLog("call setOpacity");var i=G[t];i&&(e.pbpComponent.group.setAttribute("fill-opacity",i),localStorage.setItem("pbp_opacity",t))}},{key:"_setPin",value:function(e,t){e._debugLog("call setPin"),e.pbp&&("1"===t?e.pbp.classList.add("pin"):e.pbp.classList.remove("pin")),localStorage.setItem("pbp_pin","1"===t?1:0)}},{key:"_initGuide",value:function(e){var t=localStorage.getItem("pbp_guide_closed"),i=document.getElementById(j);if("1"!==t&&!i){var a=document.createElement("style");a.innerHTML="#bilibili_pbp_guide { opacity: 0; position: absolute; z-index: 2; height: 36px; line-height: 36px; bottom: calc(100% + 12px); left: -194%; display: block; align-items: center; padding: 2px; color: #fff; background: #00a1d6; white-space: nowrap; border-radius: 4px; box-shadow: 0 3px 6px 0 rgba(0,0,0,.2); font-size: 12px; } .webfullscreen #bilibili_pbp_guide, .mode-fullscreen #bilibili_pbp_guide { left: -113%; } .bilibili-player .bilibili-player-area.video-control-show #bilibili_pbp_guide, .bilibili-player .bilibili-player-area .bilibili-player-video-control-wrap:hover #bilibili_pbp_guide { opacity: 1; } #bilibili_pbp_guide:hover { background: #00b5e5; } #bilibili_pbp_guide:hover .pbp-guide-tri { border-top: 8px solid #00b5e5 } .pbp-guide-text { color: white; padding-right: 8px; padding-left: 8px; } .pbp-guide-tri { border-top: 8px solid #00a1d6; border-left: 8px solid transparent; border-right: 8px solid transparent; position: absolute; top: 100%; right: calc(50% - 8px); }",document.head.appendChild(a),(i=document.createElement("div")).setAttribute("id",j);var r=document.createElement("span");r.setAttribute("class","pbp-guide-text"),r.innerText="新！《高能进度条》设置菜单";var n=document.createElement("span");n.setAttribute("class","pbp-guide-tri"),i.appendChild(r),i.appendChild(n),e.appendChild(i)}}},{key:"_createStateButtonGroup",value:function(a,r,e,n,o){for(var l,t=function(e,t){var i=document.createElement("div");i.innerHTML=e,t===n?(i.setAttribute("class","pbp-panel-state-button active"),l=i):i.setAttribute("class","pbp-panel-state-button"),i.onclick=function(){l.classList.remove("active"),i.classList.add("active"),l=i,o(a,t)},r.appendChild(i)},i=0;i<e.length;i++){var s=e[i];t(s.title,s.val)}}},{key:"_initPanel",value:function(i,e){this._debugLog("call _initPanel");var t=document.getElementById(R),a=document.getElementById(q),r=document.getElementsByClassName("bilibili-player-video-control-bottom-right")[0];if(!a){(a=document.createElement("style")).setAttribute("id",q),a.innerHTML="#bilibili_pbp_panel{position:relative}.pbp-panel-content-wrap{position:absolute;display:none;margin-left:-92px;bottom:41px}.webfullscreen .pbp-panel-content-wrap,.mode-fullscreen .pbp-panel-content-wrap{bottom:74px}.pbp-panel-content{cursor:auto;width:216px;background:rgba(21,21,21,.9);border-radius:2px;box-sizing:border-box;padding:12px 20px}.pbp-panel-icon-wrap{height:28px;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-transition:fill .3s;transition:fill .3s;vertical-align:middle;display:inline-block}.pbp-panel-icon{height:22px;width:22px}.webfullscreen .pbp-panel-icon,.mode-fullscreen .pbp-panel-icon{width:28px;height:28px}.pbp-panel-title{text-align:left;color:#fff;line-height:16px;font-size:12px}.pbp-panel-row{padding-bottom:8px}.pbp-panel-row:last-child{padding-bottom:0}.pbp-panel-row-content{display:flex;margin-top:4px}.pbp-panel-state-button{cursor:pointer;position:relative;border-radius:2px;color:#fff;text-align:center;margin-right:8px;background:hsla(0,0%,100%,.2);font-size:12px;flex:1;height:22px;line-height:22px}.pbp-panel-state-button:last-child{margin-right:0}.pbp-panel-state-button:hover{background:hsla(0,0%,100%,.4)}.pbp-panel-state-button.active{background:#00a1d6}.pbp-panel-state-button.active:hover{background:#00a1d6}.pbp-public-test-title{padding:1px 4px;display:inline-block;font-size:12px;-webkit-transform:scale(.7);transform:scale(.7);color:#fff;border-radius:4px;background:#f25d8e}#bilibili_pbp_panel .pbp-feedback-link{flex:1;font-size:12px;color:white;background:#f4598d;border-radius:4px;-webkit-transition:background-color .3s;transition:background-color .3s;height:22px;line-height:22px}#bilibili_pbp_panel .pbp-feedback-link:hover{color:#fff;background-color:#ff85ad}.pbp-panel-qa{display:inline-block;background:gray;transform:scale(0.8);border-radius:50%;height:16px;width:16px;text-align:center;line-height:16px;margin-left:4px;position:relative}.pbp-panel-qa-tip{position:absolute;display:none;bottom:100%;padding:8px;border-radius:4px;left:100%;background-color:#fff;background:rgba(0,0,0,.8);white-space:nowrap}.pbp-panel-qa:hover .pbp-panel-qa-tip{display:block}.pbp-panel-theme-button{cursor:pointer;position:relative;border-radius:2px;color:#fff;margin-right:6px;flex:1;height:22px;border:1px solid rgba(0,0,0,.3)}.pbp-panel-theme-button:last-child{margin-right:0}.pbp-panel-theme-button.active{-webkit-box-shadow:0 0 1px 1px #fff;box-shadow:0 0 1px 1px #fff;border-color:#000}.pbp-panel-feedback-wrap{position:absolute;top:0;right:0;overflow:hidden;width:64px;height:64px}.pbp-panel-feedback-content{position:absolute;bottom:0;bottom:50%;left:50%;width:100%;height:100%;transform:rotate(45deg)}.pbp-panel-feedback-content-row{position:absolute;bottom:0;height:30%;width:100%;background:#f25d8e;box-shadow:0 2px 4px 0 rgba(0,0,0,.6)}.pbp-panel-feedback-link-wrap{height:100%;transform:scale(0.75)}.pbp-panel-feedback-link{font-size:12px;line-height:22px;color:white;display:block;text-align:center;width:100%}.pbp-panel-feedback-link:hover{color:white;text-decoration:underline}",document.head.appendChild(a)}t&&(r.removeChild(t),t=null);var n=this;(t=document.createElement("div")).setAttribute("id",R),t.setAttribute("class","bilibili-player-video-btn"),this._initGuide(t);var o=document.createElement("span");o.setAttribute("class","pbp-panel-icon-wrap"),o.innerHTML='<img class="pbp-panel-icon" src="https://bvcstatic.acgvideo.com/pbplogo-48w.png">',t.appendChild(o);var l=document.createElement("div");l.setAttribute("class","pbp-panel-content-wrap");var s=document.createElement("div");s.setAttribute("class","pbp-panel-content");function p(){c=0,setTimeout(function(){0===c&&l.setAttribute("style","display: none;")},80)}var c=0;t.addEventListener("mouseenter",function(){if(c=1,l.setAttribute("style","display: block;"),"1"!==localStorage.getItem("pbp_guide_closed")){var e=document.getElementById(j);e&&(t.removeChild(e),localStorage.setItem("pbp_guide_closed",1))}}),t.addEventListener("mouseleave",function(){p()}),l.addEventListener("mouseenter",function(){c=1}),l.addEventListener("mouseleave",function(){p()});var d=document.createElement("div");d.setAttribute("class","pbp-panel-feedback-wrap");var b=document.createElement("div");b.setAttribute("class","pbp-panel-feedback-content");var u=document.createElement("div");u.setAttribute("class","pbp-panel-feedback-content-row");var h=document.createElement("div");h.setAttribute("class","pbp-panel-feedback-link-wrap");var g=document.createElement("a");g.setAttribute("class","pbp-panel-feedback-link"),g.setAttribute("href","https://www.bilibili.com/blackboard/activity-KMbzFht4z.html?from=panel"),g.setAttribute("target","_blank"),g.innerHTML="公测评价",h.appendChild(g),u.appendChild(h),b.appendChild(u),d.appendChild(b),s.appendChild(d);var v=document.createElement("div");v.setAttribute("class","pbp-panel-row");var m=document.createElement("div");m.innerHTML='高能进度条<div class="pbp-panel-qa">?<div class="pbp-panel-qa-tip">代表多数用户拖动的位置或弹幕密集区，避免您错过精彩内容！</div></div>',m.setAttribute("class","pbp-panel-title");var f=document.createElement("div");f.setAttribute("class","pbp-panel-row-content");var y=localStorage.getItem("pbpstate");this._createStateButtonGroup(n,f,[{title:"开",val:"1"},{title:"关",val:"0"}],y,function(e,t){"1"===t?(localStorage.setItem("pbpstate",1),e.show()):(localStorage.setItem("pbpstate",0),e.hide())}),v.appendChild(m),v.appendChild(f),s.appendChild(v);var w=document.createElement("div");w.setAttribute("class","pbp-panel-row");var _=document.createElement("div");_.innerHTML="高度",_.setAttribute("class","pbp-panel-title");var x=document.createElement("div");x.setAttribute("class","pbp-panel-row-content");var C=localStorage.getItem("pbp_height");C=K[C]?C:"m",this._createStateButtonGroup(n,x,[{title:"低",val:"l"},{title:"中",val:"m"},{title:"高",val:"h"}],C,n._setHeight),w.appendChild(_),w.appendChild(x),s.appendChild(w);var k=document.createElement("div");k.setAttribute("class","pbp-panel-row");var A=document.createElement("div");A.innerHTML="透明度",A.setAttribute("class","pbp-panel-title"),k.appendChild(A);var S=document.createElement("div");S.setAttribute("class","pbp-panel-row-content");var E=localStorage.getItem("pbp_opacity");E=G[E]?E:"m",this._createStateButtonGroup(n,S,[{title:"低",val:"l"},{title:"中",val:"m"},{title:"高",val:"h"}],E,n._setOpacity),k.appendChild(S),s.appendChild(k);var z=document.createElement("div");z.setAttribute("class","pbp-panel-row");var L=document.createElement("div");L.innerHTML='常驻模式<div class="pbp-panel-qa">?<div class="pbp-panel-qa-tip">当面板隐藏的时候保持高能进度条展示</div></div>',L.setAttribute("class","pbp-panel-title"),z.appendChild(L);var I=document.createElement("div");I.setAttribute("class","pbp-panel-row-content");var P=localStorage.getItem("pbp_pin");P||(P="1",localStorage.setItem("pbp_pin","1")),this._createStateButtonGroup(n,I,[{title:"开",val:"1"},{title:"关",val:"0"}],P,n._setPin),z.appendChild(I),s.appendChild(z);var T=document.createElement("div");T.setAttribute("class","pbp-panel-row");var F=document.createElement("div");F.innerHTML="主题",F.setAttribute("class","pbp-panel-title"),T.appendChild(F);var B=document.createElement("div");B.setAttribute("class","pbp-panel-row-content");var Z,H=localStorage.getItem("pbp_theme");H=J[H]?H:"b";function D(e){var t=document.createElement("div");t.style.backgroundColor="rgb(".concat(J[e].playedColor,")"),e===H?(t.setAttribute("class","pbp-panel-theme-button active"),Z=t):t.setAttribute("class","pbp-panel-theme-button"),t.onclick=function(){Z.classList.remove("active"),t.classList.add("active"),Z=t,n._setTheme(e)},B.appendChild(t)}if(D("b"),D("p"),D("g"),D("r"),T.appendChild(B),s.appendChild(T),this.debug){var M=document.createElement("div");M.setAttribute("class","pbp-panel-row");var N=document.createElement("div");N.innerHTML="Debug",N.setAttribute("class","pbp-panel-title"),M.appendChild(N);var U=document.createElement("div");U.setAttribute("class","pbp-panel-row-content");var O=document.createElement("select");O.setAttribute("style","width: 100%; font-size: 12px; color: black;"),O.addEventListener("change",function(){var e=O.selectedIndex,t=O.options[e].getAttribute("value");localStorage.setItem("pbp_debug_key",t),window.location.reload()}),Object.keys(e).forEach(function(e){var t=new Option(e,e);e===i&&t.setAttribute("selected",""),O.add(t)}),U.appendChild(O),M.appendChild(U),s.appendChild(M)}l.appendChild(s),t.appendChild(l),r.insertBefore(t,r.firstChild)}},{key:"_saveZebraAreas",value:function(){if(null!==this.zebraStart&&null!==this.zebraEnd){for(var e=0;e<this.zebraAreas.length;e++){var t=this.zebraAreas[e][0],i=this.zebraAreas[e][1];if(this.zebraStart>i){if(e+1!==this.zebraAreas.length)continue;this.zebraAreas.push([this.zebraStart,this.zebraEnd]);break}if(this.zebraStart>=t&&this.zebraEnd<=i)break;this.zebraStart<=t&&this.zebraEnd>=t&&this.zebraEnd<i?this.zebraAreas[e]=[this.zebraStart,i]:this.zebraStart>=t&&this.zebraStart<=i&&this.zebraEnd>i?this.zebraAreas[e]=[t,this.zebraEnd]:this.zebraAreas.splice(e,0,[this.zebraStart,this.zebraEnd]);break}if(1<this.zebraAreas.length){for(var a=[],r=this.zebraAreas[0][1],n=0,o=1;o<this.zebraAreas.length;o++){var l=this.zebraAreas[o][0],s=this.zebraAreas[o][1];l<r?(r<s&&(this._debugLog("delete merge end"),this.zebraAreas[n]=[this.zebraAreas[n][0],s],r=s,n=o),this._debugLog("delete: ".concat(o,", ").concat(l,", ").concat(s)),a.push(o)):(r=s,n=o)}var p=this;a.forEach(function(e,t){p._debugLog("delete start: ".concat(e-t)),p.zebraAreas.splice(e-t,1)})}else this.zebraAreas.push([this.zebraStart,this.zebraEnd]);this._refreshZebraClipPath()}}},{key:"_recoverZebraDataFromCache",value:function(){this._debugLog("call _recoverZebraDataFromCache");for(var e=localStorage.getItem("pbp_zebra_cache"),t=JSON.parse(e||"[]"),i=0;i<t.length;i++){var a=t[i];if(this.cid===a.cid)return this.zebraAreas=a.data,this.cachedZebraDataIndex=i,void(this.cachedZebraDatas=t)}10<=t.length&&(this._debugLog("recovery zebra cache: max item delete first"),t.shift()),this.cachedZebraDataIndex=t.length,t.push({cid:this.cid,data:[]}),this.cachedZebraDatas=t}},{key:"_cacheZebraData",value:function(){this.zebraAreas&&this.cachedZebraDatas&&"number"==typeof this.cachedZebraDataIndex&&(this._debugLog("call _cacheZebraData"),this.cachedZebraDatas[this.cachedZebraDataIndex].data=this.zebraAreas,localStorage.setItem("pbp_zebra_cache",JSON.stringify(this.cachedZebraDatas)))}},{key:"_generateBezierCurvePath",value:function(e,t,i){var a=.2*i,r=e[1].wPercentage*t/2,n=["M 0 100 L 0 ".concat(i-a)],o=0,l=i-a;e.push({wPercentage:1,hPercentage:0});for(var s=1;s<e.length;s++){var p=e[s],c=p.wPercentage*t,d=i-(a+.8*p.hPercentage*i),b=o+r;n.push("C ".concat(b.toFixed(1)," ").concat(l.toFixed(1),", ").concat(b.toFixed(1)," ").concat(d.toFixed(1),", ").concat(c.toFixed(1)," ").concat(d.toFixed(1))),o=c,l=d}n.push("L 1000 100 Z");var u=n.join(" ");return this._debugLog("call _generateBezierCurvePath: ".concat(u)),u}},{key:"_generateZebraPath",value:function(e,t){for(var i=[],a=0;a<e.length;a++){var r=e[a],n=t*r[0],o=t*r[1];i.push("M ".concat(n.toFixed(1)," 100 H ").concat(o.toFixed(1)," V 0 H ").concat(n.toFixed(1)," Z"))}var l=i.join(" ");return this._debugLog("call _generateZebraPath: ".concat(l)),l}},{key:"_create",value:function(){var e;if(this.st){var t=document.getElementById(h);if(!t){(t=document.createElement("div")).setAttribute("id",h);var i=document.createElementNS("http://www.w3.org/2000/svg","svg");i.setAttribute("viewBox","0 0 ".concat(v," ").concat(100)),i.setAttribute("preserveAspectRatio","none"),i.setAttribute("width","100%"),i.setAttribute("height","100%");var a=document.createElementNS("http://www.w3.org/2000/svg","defs"),r=document.createElementNS("http://www.w3.org/2000/svg","clipPath");r.setAttribute("id","pbp-curve-path"),r.setAttribute("clipPathUnits","userSpaceOnUse");var n=document.createElementNS("http://www.w3.org/2000/svg","path");n.setAttribute("d",this._generateBezierCurvePath(this.st.points,v,100)),r.appendChild(n);var o=document.createElementNS("http://www.w3.org/2000/svg","clipPath");o.setAttribute("id","pbp-played-path"),o.setAttribute("clipPathUnits","userSpaceOnUse");var l=document.createElementNS("http://www.w3.org/2000/svg","rect");l.setAttribute("x","0"),l.setAttribute("width","0"),l.setAttribute("y","0"),l.setAttribute("height","100%"),o.appendChild(l);var s=document.createElementNS("http://www.w3.org/2000/svg","path");s.setAttribute("d",this._generateZebraPath(this.zebraAreas,v)),o.appendChild(s),a.appendChild(r),a.appendChild(o);var p=document.createElementNS("http://www.w3.org/2000/svg","g");p.setAttribute("fill-opacity",this.st.opacity),p.setAttribute("clip-path","url(#pbp-curve-path)"),p.setAttribute("class","bilibili-player-videoshot-area");var c=document.createElementNS("http://www.w3.org/2000/svg","rect");c.setAttribute("x","0"),c.setAttribute("y","0"),c.setAttribute("width","100%"),c.setAttribute("height","100%"),c.setAttribute("fill",this.st.fillColor),p.appendChild(c);var d=document.createElementNS("http://www.w3.org/2000/svg","rect");d.setAttribute("x","0"),d.setAttribute("y","0"),d.setAttribute("width","100%"),d.setAttribute("height","100%"),d.setAttribute("fill",this.st.playedColor),d.setAttribute("clip-path","url(#pbp-played-path)"),p.appendChild(d);var b=document.createElementNS("http://www.w3.org/2000/svg","line");b.setAttribute("y1","0"),b.setAttribute("y2","100%"),b.setAttribute("style","stroke: white; stroke-width: 1;"),p.appendChild(b),i.appendChild(a),i.appendChild(p),t.appendChild(i),document.getElementsByClassName(g)[0].appendChild(t),window.player.getPlayerState()&&window.player.getPlayerState().controller.show?t.classList.add("show"):t.classList.remove("show"),p.addEventListener("click",function(e){var t=e.offsetX/i.getBoundingClientRect().width;window.player.seek(t*window.player.getDuration()),window.player.track("slidepbp")}),this.pbp=t,this.pbpComponent=(u(e={pbpSvg:i,group:p,currentRect:l,zebraPath:s},"group",p),u(e,"fillRect",c),u(e,"playedRect",d),u(e,"currentTimeLine",b),e)}}}},{key:"_refresh",value:function(){if(null!==this.zebraStart&&null!==this.zebraEnd&&this.zebraEnd>this.zebraStart){var e=this.pbpComponent.currentRect,t=100*this.zebraStart,i=100*this.zebraEnd-t;e.setAttribute("x","".concat(t.toFixed(2),"%")),e.setAttribute("width","".concat(i.toFixed(2),"%"))}var a=this.video.currentTime;this.firstRefreshFlag||(a=0,this.firstRefreshFlag=!0);var r=a/this.video.duration*v-.5;r=0<=r?r:0;var n=this.pbpComponent.currentTimeLine;n.setAttribute("x1","".concat(r)),n.setAttribute("x2","".concat(r))}},{key:"_refreshZebraClipPath",value:function(){this.pbpComponent.zebraPath.setAttribute("d",this._generateZebraPath(this.zebraAreas,v))}},{key:"_observerChange",value:function(){var r=this;this._debugLog("observer change"),this.videoUpdateCallback=function(e){var t=e.target.currentTime/r.video.duration||0;if("timeupdate"===e.type){var i=t*r.video.duration,a=!1;r.lastUpdateTime&&(a=i<r.lastUpdateTime||1.5<i-r.lastUpdateTime),a?(r._debugLog("invalid update, ignore."),r._saveZebraAreas(),r.zebraStart=null,r.zebraEnd=null,r.lastUpdateTime=null):(null===r.zebraStart&&(r.zebraStart=Number(t.toFixed(4))),r.zebraEnd=Number(t.toFixed(4)),r.lastUpdateTime=i)}else"seeking"===e.type&&(r._saveZebraAreas(),r.zebraStart=null,r.zebraEnd=null,r.lastUpdateTime=null);r._refresh()};var i=this.pbp.classList;this.videoControlbarCallback=function(e,t){t.show?i.add("show"):i.remove("show")},this.videoHeartbeatCallback=function(e,t){if(r.videoHeartbeatFirstFlag){var i=window.player.getCurrentTime()/window.player.getDuration()||0;i=Number(i.toFixed(4)),r._debugLog("call video heartbeat: ".concat(i,", zebra time: ").concat(r.zebraStart," - ").concat(r.zebraEnd)),r.zebraEnd=i,r._saveZebraAreas(),r.zebraStart=r.zebraEnd,r.lastUpdateTime=null,r._cacheZebraData()}else r.videoHeartbeatFirstFlag=!0},this.video.addEventListener("seeking",this.videoUpdateCallback),this.video.addEventListener("timeupdate",this.videoUpdateCallback),window.player.addEventListener("video_controlbar",this.videoControlbarCallback),window.player.addEventListener("video_heartbeat",this.videoHeartbeatCallback)}},{key:"_calculatePercentage",value:function(e,t){var i=this.video.duration,a=Math.floor(i/t);this._debugLog("video_len:".concat(a," data_len:").concat(e.length)),a>e.length&&(e=e.concat(new Array(a-e.length).fill(0)));for(var r=e.length*t,n=e.reduce(function(e,t){return t<e?e:t},0),o=[],l=0;l<e.length;l++){var s=e[l],p=s/n;p=p||0,o.push({value:s,hPercentage:p,wPercentage:l*t/r})}return o}},{key:"_debugLog",value:function(){for(var e,t=arguments.length,i=new Array(t),a=0;a<t;a++)i[a]=arguments[a];this.debug&&(e=console).log.apply(e,["[PBP DEBUG]: "].concat(i))}},{key:"_injectBiliPlayer",value:function(){var r=this,n=10;return new Promise(function e(t,i){var a=document.querySelector(".".concat("bilibili-player-video-wrap"));if(window.BilibiliPlayer&&a)r.aid=+window.aid,r.cid=+window.cid,r.player=a,t();else{if(0===(n-=1))return void i("miss BilibiliPlayer");setTimeout(function(){e(t,i)},500)}})}},{key:"stateStore",get:function(){var e={status:"disable",data:[],version:"2.0.2"};this.st&&this.st.points&&(e.data=this.st.points),e.data.length?"show"===this._status?e.status="enable":e.status="disable":e.status="enableFail";var t=localStorage.getItem("pbp_pin");t="1"===t?t:"0";var i=localStorage.getItem("pbp_height");i=K[i]?i:"m";var a=localStorage.getItem("pbp_opacity");a=G[a]?a:"m";var r=localStorage.getItem("pbp_theme");return r=J[r]?r:"b",e.pbpstatus=e.status,e.pbptag=this._pbptag,e.pbptag.pbppin=Number(t),e.pbptag.pbpheight=i,e.pbptag.pbpopacity=a,e.pbptag.theme=r,e.pbptagstr=this._pbptagstr+"&pbppin_"+t+"&pbpheight_"+i+"&pbpopacity_"+a+"&pbptheme_"+r,e}}]),a}();return setTimeout(function(){try{localStorage.getItem("pbpstate_clear")||(localStorage.removeItem("pbpstate"),localStorage.setItem("pbpstate_clear","1")),localStorage.getItem("pbpstate")||localStorage.setItem("pbpstate","1")}catch(e){console.error(e)}t.loadLab(10)},0),t});